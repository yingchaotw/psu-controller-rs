// ui/appwindow.slint
import { Button, VerticalBox, LineEdit, HorizontalBox, ComboBox, TabWidget, CheckBox } from "std-widgets.slint";
import { Theme } from "theme.slint";
import { Card } from "components/card.slint";
import { ValueControlCard } from "components/value_control.slint";
import { SettingsOverlay } from "components/settings_overlay.slint";
import { TrendChart } from "components/chart.slint";

export component AppWindow inherits Window {
    title: root.window-title;
    in-out property <string> window-title: "Rust PSU Controller";
    width: 800px;
    height: 600px; 
    background: Theme.background; 

    // --- Â±¨ÊÄß ---
    in-out property <[string]> available-ports: []; 
    in-out property <string> selected-port;
    in-out property <string> status-text: "Disconnected";
    in-out property <brush> status-color: #ff5555;
    in-out property <string> message-text: "---";
    in-out property <bool> show-settings: false;
    in-out property <bool> is-looping: false;
    in-out property <bool> enable-auto-refresh: true;
    in-out property <bool> is-output-on: false;
    in-out property <string> psu-mode: "CV"; // È†êË®≠ CV
    in-out property <string> chart-data: "";
    in-out property <bool> show-chart: false;

    // --- Êï∏ÂÄº ---
    in-out property <string> voltage-reading: "---";
    in-out property <string> current-reading: "---";
    in-out property <string> target-voltage: "12.00";
    in-out property <string> target-current: "1.000";
    in-out property <string> polling-interval: "1000";

    // --- Callbacks (Á∂≠ÊåÅ‰∏çËÆä) ---
    callback toggle_connection();
    callback send_command(string);
    callback read_all();
    callback read_voltage();
    callback read_current();
    callback apply_voltage(string);
    callback apply_current(string);
    callback adjust_voltage(float);
    callback adjust_current(float);
    callback confirm_reset();
    callback toggle_loop(string, string, int);
    callback toggle_auto_refresh(bool);

    VerticalBox {
        padding: 15px; spacing: 10px;

        // --- Header ---
        HorizontalBox {
            spacing: 10px;
            Text { text: "Port:"; vertical-alignment: center; color: white; }
            ComboBox {
                model: root.available-ports;
                current-value <=> root.selected-port;
                width: 150px;
            }
            Button {
                text: root.status-text == "Connected" ? "Disconnect" : "Connect";
                primary: root.status-text != "Connected";
                clicked => { 
                    if (root.status-text == "Connected") { root.is-output-on = false; }
                    root.toggle_connection(); 
                }
            }
            
            // [‰øÆÊîπ] Auto-Poll ÂçÄÂ°ä
            HorizontalBox {
                spacing: 5px;

                CheckBox {
                    text: "Auto-Poll";
                    checked <=> root.enable-auto-refresh;
                    toggled => { root.toggle_auto_refresh(self.checked); }
                }
                
                // [Êñ∞Â¢û] È†ªÁéáË®≠ÂÆöËº∏ÂÖ•Ê°Ü
                Text { text: "Interval:"; color: #aaa; vertical-alignment: center; font-size: 12px; }
                LineEdit { 
                    text <=> root.polling-interval; 
                    width: 50px; 
                    placeholder-text: "ms";
                    // Áï∂Ëº∏ÂÖ•ÊîπËÆä‰∏îÁõÆÂâçÊ≠£Âú®Ë∑ë Auto-Poll ÊôÇÔºåÈáçÊñ∞Ëß∏Áôº‰∏ÄÊ¨° toggle ‰æÜÊõ¥Êñ∞ Timer
                    accepted => { 
                        if (root.enable-auto-refresh) {
                            root.toggle_auto_refresh(true);
                        }
                    }
                }
                Text { text: "ms"; color: #aaa; vertical-alignment: center; font-size: 12px; }
            }

            VerticalLayout { alignment: center; Rectangle { width: 12px; height: 12px; border-radius: 6px; background: root.status-color; } }
            
            Rectangle { horizontal-stretch: 1; }

            Button { text: "‚öô Sys"; width: 60px; clicked => { root.show-settings = true; } }
        }

        // --- Tabs ---
        TabWidget {
            Tab {
                title: "Manual Control";
                HorizontalBox {
                    spacing: 15px; padding: 15px;
                    
                    // 1. Voltage (‰ΩøÁî®ÂÖÉ‰ª∂)
                    ValueControlCard {
                        title: "VOLTAGE (V)";
                        reading: root.voltage-reading;
                        reading-color: #55ff55; // Á∂†Ëâ≤Â≠ó
                        unit: "Set";
                        target-value <=> root.target-voltage;

                        // [ÈÄ£Êé•Ë®äËôü] ËÆìÈõªÂ£ìÂç°Áâá‰πüËÉΩÈ°ØÁ§∫Ê®°Âºè (ÈÅ∏Áî®)
                        // Â¶ÇÊûúÊòØ CV Ê®°ÂºèÔºåÈÄöÂ∏∏ÈõªÂ£ìÊòØÁ©©ÂÆöÁöÑÔºåÈ°ØÁ§∫Âú®ÈÄôË£°‰πüÂêàÁêÜ
                        mode: root.psu-mode;
                        
                        request-read => { root.read_voltage(); }
                        request-apply => { root.apply_voltage(root.target-voltage); }
                        request-adjust(val) => { root.adjust_voltage(val * 0.1); }
                    }

                    // 2. Current (‰ΩøÁî®ÂÖÉ‰ª∂)
                    ValueControlCard {
                        title: "CURRENT (A)";
                        reading: root.current-reading;
                        reading-color: #55ffff; // ÈùíËâ≤Â≠ó
                        unit: "Lim";
                        target-value <=> root.target-current;

                        // [ÈÄ£Êé•Ë®äËôü] ËÆìÈõªÊµÅÂç°ÁâáÈ°ØÁ§∫Ê®°Âºè
                        // Â¶ÇÊûúÈÄ≤ÂÖ• CC Ê®°ÂºèÔºåÈÄôË£°ÊúÉËÆäÁ¥ÖËâ≤ "CC"
                        mode: root.psu-mode;

                        request-read => { root.read_current(); }
                        request-apply => { root.apply_current(root.target-current); }
                        request-adjust(val) => { root.adjust_current(val * 0.01); }
                    }
                }
            }

            Tab {
                title: "Auto Loop";
                VerticalBox {
                    padding: 20px; alignment: start; 
                    // Card ‰πüÂèØ‰ª•Áõ¥Êé•Áî®
                    Card {
                        title: "LOOP CONFIGURATION";
                        VerticalBox {
                            spacing: 15px;
                            Text { text: "Toggle voltage between Level A and B."; color: Theme.text-secondary; }
                            HorizontalBox {
                                Text { text: "Level A (V):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-va := LineEdit { text: "5.0"; }
                            }
                            HorizontalBox {
                                Text { text: "Level B (V):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-vb := LineEdit { text: "12.0"; }
                            }
                            HorizontalBox {
                                Text { text: "Interval (ms):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-ms := LineEdit { text: "1000"; }
                            }
                            Rectangle { height: 10px; }
                            Button {
                                text: root.is-looping ? "üõë STOP LOOP" : "‚ñ∂ START LOOP";
                                primary: root.is-looping; height: 50px;
                                clicked => { root.toggle_loop(loop-va.text, loop-vb.text, loop-ms.text.to-float()); }
                            }
                        }
                    }
                }
            }
        }

        // [Êñ∞Â¢û] Ë∂®Âã¢ÂúñÂçÄÂ°ä
        if (root.show-chart) : VerticalBox {
            spacing: 5px;
            Text { 
                text: "Voltage Trend (10s)"; 
                color: #aaa; 
                font-size: 12px; 
            }
            TrendChart {
                height: 100px;
                line-color: #00ff00;
                chart-path: root.chart-data;
            }
        }

        // --- Footer ---
        HorizontalBox {
            height: 50px; spacing: 20px;
            Button {
                text: "OUTPUT ON"; primary: root.is-output-on; enabled: root.status-text == "Connected";
                clicked => { root.is-output-on = true; root.send_command("OUTP ON"); }
            }
            Button {
                text: "OUTPUT OFF"; enabled: root.status-text == "Connected";
                clicked => { root.is-output-on = false; root.send_command("OUTP OFF"); }
            }
        }
    }

    // --- Overlay ---
    SettingsOverlay {
        visible-flag: root.show-settings;
        close => { root.show-settings = false; }
        send-cmd(cmd) => { root.send_command(cmd); }
        trigger-reset => {
            root.is-output-on = false;
            root.confirm_reset();
            root.show-settings = false;
        }
    }
}