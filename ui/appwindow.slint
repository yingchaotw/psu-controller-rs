// ui/appwindow.slint
import { Button, VerticalBox, LineEdit, HorizontalBox, ComboBox, TabWidget, CheckBox } from "std-widgets.slint";
import { Theme } from "theme.slint";
import { Card } from "components/card.slint";
import { ValueControlCard } from "components/value_control.slint";
import { SettingsOverlay } from "components/settings_overlay.slint";
import { TrendChart } from "components/chart.slint";

export component AppWindow inherits Window {
    title: root.window-title;
    in-out property <string> window-title: "Rust PSU Controller";
    width: 800px;
    // height: 600px; // å»ºè­°æ‹¿æ‰å›ºå®šé«˜åº¦ï¼Œè®“è¦–çª—è‡ªå‹•é©æ‡‰å…§å®¹
    background: Theme.background; 

    // --- å±¬æ€§ ---
    in-out property <[string]> available-ports: []; 
    in-out property <string> selected-port;
    in-out property <string> status-text: "Disconnected";
    in-out property <brush> status-color: #ff5555;
    in-out property <string> message-text: "---";
    in-out property <bool> show-settings: false;
    in-out property <bool> is-looping: false;
    in-out property <bool> enable-auto-refresh: true;
    in-out property <bool> is-output-on: false;
    in-out property <string> psu-mode: "CV"; // é è¨­ CV
    in-out property <string> chart-data-v: ""; // Voltage Path
    in-out property <string> chart-data-i: ""; // Current Path
    in-out property <bool> show-chart: true;
    in-out property <float> active-voltage-target: 0.0;
    in-out property <float> active-current-limit: 1.0; // çµ¦å€‹é è¨­å€¼é¿å…é™¤ä»¥0

    // --- æ•¸å€¼ ---
    in-out property <string> voltage-reading: "---";
    in-out property <string> current-reading: "---";
    in-out property <string> target-voltage: "12.00";
    in-out property <string> target-current: "1.000";
    in-out property <string> polling-interval: "200";
    in-out property <string> power-reading: "0.00";
    in-out property <string> chart-duration: "10s";

    // --- Callbacks (ç¶­æŒä¸è®Š) ---
    callback toggle_connection();
    callback send_command(string);
    callback read_all();
    callback read_voltage();
    callback read_current();
    callback apply_voltage(string);
    callback apply_current(string);
    callback adjust_voltage(float);
    callback adjust_current(float);
    callback confirm_reset();
    callback toggle_loop(string, string, int);
    callback toggle_auto_refresh(bool);

    VerticalBox {
        padding: 15px; spacing: 10px;

        // --- Header ---
        HorizontalBox {
            spacing: 10px;

            VerticalLayout { alignment: center; Rectangle { width: 12px; height: 12px; border-radius: 6px; background: root.status-color; } }

            Text { text: "Port:"; vertical-alignment: center; color: white; }
            ComboBox {
                model: root.available-ports;
                current-value <=> root.selected-port;
                width: 150px;
            }
            Button {
                text: root.status-text == "Connected" ? "Disconnect" : "Connect";
                primary: root.status-text != "Connected";
                clicked => { 
                    if (root.status-text == "Connected") { root.is-output-on = false; }
                    root.toggle_connection(); 
                }
            }
            
            // Auto-Poll å€å¡Š
            HorizontalBox {
                spacing: 5px;

                CheckBox {
                    text: "Auto-Poll";
                    checked <=> root.enable-auto-refresh;
                    toggled => { root.toggle_auto_refresh(self.checked); }
                }
                
                // é »ç‡è¨­å®šè¼¸å…¥æ¡†
                Text { text: "Interval:"; color: #aaa; vertical-alignment: center; font-size: 12px; }
                
                LineEdit { 
                    text <=> root.polling-interval; 
                    
                    // ğŸ”´ [ä¿®æ­£ 1] åŠ å¤§å¯¬åº¦ (åŸæœ¬ 50px å¤ªæ“ ï¼ŒX æœƒæ“‹ä½å­—)
                    width: 80px; 
                    
                    // ğŸŸ¢ [å„ªåŒ–] è®“æ•¸å­—ç½®ä¸­é¡¯ç¤ºï¼Œæ¯”è¼ƒåƒå„€å™¨è¨­å®š
                    horizontal-alignment: center;

                    placeholder-text: "ms";
                    
                    // ç•¶è¼¸å…¥æ”¹è®Šä¸”ç›®å‰æ­£åœ¨è·‘ Auto-Poll æ™‚ï¼Œé‡æ–°è§¸ç™¼ä¸€æ¬¡ toggle ä¾†æ›´æ–° Timer
                    accepted => { 
                        if (root.enable-auto-refresh) {
                            root.toggle_auto_refresh(true);
                        }
                    }
                }
                Text { text: "ms"; color: #aaa; vertical-alignment: center; font-size: 12px; }
            }
            
            Rectangle { horizontal-stretch: 1; }

            Button { text: "âš™ Sys"; width: 60px; clicked => { root.show-settings = true; } }
        }

        // --- Tabs ---
        TabWidget {
            Tab {
                title: "Manual Control";
                
                // å·¦å³ä¸¦æ’ä½ˆå±€
                HorizontalBox {
                    padding: 20px;
                    spacing: 20px; // å·¦é‚Šé¢æ¿èˆ‡å³é‚ŠæŒ‰éˆ•çš„é–“è·
                    alignment: center; // æ•´é«”ç½®ä¸­

                    // --- å·¦é‚Šå€å¡Šï¼šæ§åˆ¶é¢æ¿ (Card) ---
                    Card {
                        title: "OUTPUT CHANNEL";
                        width: 450px; // çµ¦å®šå¯¬åº¦ï¼Œè®“ç‰ˆé¢æ¯”è¼ƒç©©é‡
                        
                        // Card å…§éƒ¨ä¾ç„¶æ˜¯ç”¨ VerticalLayout æŠŠé›»å£“/é›»æµä¸Šä¸‹ç–Šèµ·ä¾†
                        VerticalLayout {
                            padding: 10px;
                            spacing: 15px;

                            // 1. é›»å£“æ§åˆ¶åˆ—
                            ValueControlCard {
                                title: "V"; 
                                reading: root.voltage-reading;
                                reading-color: #55ff55;
                                unit: "Set";
                                target-value <=> root.target-voltage;
                                mode: root.psu-mode == "CV" ? "CV" : "";
                                
                                request-read => { root.read_voltage(); }
                                request-apply => { root.apply_voltage(root.target-voltage); }
                                request-adjust(val) => { root.adjust_voltage(val * 0.1); }
                            }

                            Rectangle { height: 1px; background: #444; }

                            // 2. é›»æµæ§åˆ¶åˆ—
                            ValueControlCard {
                                title: "A"; 
                                reading: root.current-reading;
                                reading-color: #55ffff;
                                unit: "Limit";
                                target-value <=> root.target-current;
                                mode: root.psu-mode == "CC" ? "CC" : "";
                                
                                request-read => { root.read_current(); }
                                request-apply => { root.apply_current(root.target-current); }
                                request-adjust(val) => { root.adjust_current(val * 0.01); }
                            }
                            // ğŸŸ¢ [æ–°å¢] åˆ†éš”ç·š
                            Rectangle { height: 1px; background: #444; }

                            // ğŸŸ¢ [æ–°å¢] åŠŸç‡é¡¯ç¤ºåˆ— (ç´”é¡¯ç¤ºï¼Œç„¡æ§åˆ¶åŠŸèƒ½)
                            Rectangle {
                                height: 50px; // é«˜åº¦èˆ‡ä¸Šé¢ä¸€è‡´
                                background: Theme.display-bg; // ä½¿ç”¨è¢å¹•èƒŒæ™¯è‰²
                                border-radius: 4px;
                                
                                HorizontalLayout {
                                    padding-left: 10px; 
                                    padding-right: 10px;
                                    alignment: space-between; // é å…©é‚Šå°é½Š

                                    // å·¦å´ï¼šæ¨™ç±¤èˆ‡æ•¸å€¼
                                    HorizontalLayout {
                                        spacing: 10px;
                                        
                                        // å°æ¨™é¡Œ W
                                        Text { 
                                            text: "W";
                                            color: #888;
                                            font-size: 12px;
                                            font-weight: 700;
                                            vertical-alignment: center;
                                        }

                                        // åŠŸç‡æ•¸å€¼
                                        Text { 
                                            text: root.power-reading; 
                                            color: #ff55ff; // æ´‹ç´…è‰²ï¼Œå€åˆ† V/I
                                            font-size: 32px; 
                                            font-weight: 700; 
                                            vertical-alignment: center; 
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // --- å³é‚Šå€å¡Šï¼šå·¨å¤§çš„é–‹é—œæŒ‰éˆ• ---
                    VerticalLayout {
                        alignment: center; // å‚ç›´ç½®ä¸­
                        
                        // [ä¿®æ”¹] åˆä½µæˆå–®ä¸€æŒ‰éˆ•
                        Button {
                            // æ–‡å­—é‚è¼¯ï¼šé¡¯ç¤º OUTPUT ä»¥åŠç›®å‰çš„ç‹€æ…‹
                            text: root.is-output-on ? "OUTPUT\nON" : "OUTPUT\nOFF";
                            
                            // é¡è‰²é‚è¼¯ï¼šON çš„æ™‚å€™äº®ç‡ˆ (Primary Color)ï¼ŒOFF çš„æ™‚å€™æš— (é è¨­ç°è‰²)
                            primary: root.is-output-on;
                            
                            // åªæœ‰é€£ç·šæ™‚æ‰èƒ½æŒ‰
                            enabled: root.status-text == "Connected";
                            
                            // æ¨£å¼ï¼šåšæˆæ­£æ–¹å½¢æˆ–ç¨å¾®å¤§ä¸€é»çš„çŸ©å½¢ï¼Œå¥½æŒ‰
                            width: 100px;
                            height: 100px; 
                            
                            // é»æ“Šé‚è¼¯ï¼šåˆ‡æ›ç‹€æ…‹
                            clicked => { 
                                if (root.is-output-on) {
                                    // å¦‚æœåŸæœ¬æ˜¯ ONï¼Œå°±é—œæ‰
                                    root.is-output-on = false; 
                                    root.send_command("OUTP OFF"); 
                                } else {
                                    // å¦‚æœåŸæœ¬æ˜¯ OFFï¼Œå°±æ‰“é–‹
                                    root.is-output-on = true; 
                                    root.send_command("OUTP ON"); 
                                }
                            }
                        }
                    }
                }
            }

            Tab {
                title: "Auto Loop";
                VerticalBox {
                    padding: 20px; alignment: start; 
                    // Card ä¹Ÿå¯ä»¥ç›´æ¥ç”¨
                    Card {
                        title: "LOOP CONFIGURATION";
                        VerticalBox {
                            spacing: 15px;
                            Text { text: "Toggle voltage between Level A and B."; color: Theme.text-secondary; }
                            HorizontalBox {
                                Text { text: "Level A (V):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-va := LineEdit { text: "5.0"; }
                            }
                            HorizontalBox {
                                Text { text: "Level B (V):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-vb := LineEdit { text: "12.0"; }
                            }
                            HorizontalBox {
                                Text { text: "Interval (ms):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-ms := LineEdit { text: "1000"; }
                            }
                            Rectangle { height: 10px; }
                            Button {
                                text: root.is-looping ? "ğŸ›‘ STOP LOOP" : "â–¶ START LOOP";
                                primary: root.is-looping; height: 50px;
                                clicked => { root.toggle_loop(loop-va.text, loop-vb.text, loop-ms.text.to-float()); }
                            }
                        }
                    }
                }
            }
        }

        // --- è¶¨å‹¢åœ–å€å¡Š ---
        if (root.show-chart) : VerticalBox {
            vertical-stretch: 0; // é¿å…ä½”ç”¨éå¤šç©ºé–“
            spacing: 5px;
            
            // æ¨™é¡Œé¡¯ç¤ºé¡è‰²èªªæ˜
            HorizontalLayout {
                spacing: 10px;

                // [ä¿®æ”¹] é€™è£¡ä¸å†å¯«æ­» "Trend (10s)"ï¼Œè€Œæ˜¯ç”¨è®Šæ•¸çµ„åˆ
                Text { 
                    text: "Trend (" + root.chart-duration + "):"; 
                    color: #aaa; 
                    font-size: 12px; 
                }

                Text { text: "Voltage"; color: #55ff55; font-size: 12px; font-weight: 700; }
                Text { text: "/"; color: #666; font-size: 12px; }
                Text { text: "Current"; color: #55ffff; font-size: 12px; font-weight: 700; }
            }
            
            TrendChart {
                height: 120px; // ç¨å¾®åŠ é«˜ä¸€é»è®“å…©æ¢ç·šä¸é‚£éº¼æ“ 
                // [ç¶å®š]
                path-voltage: root.chart-data-v;
                path-current: root.chart-data-i;
            }
        }

        // ğŸ”´ [å·²åˆªé™¤] åŸæœ¬é€™è£¡çš„ Footer (é‡è¤‡çš„æŒ‰éˆ•) å·²ç¶“è¢«ç§»é™¤äº†
    }

    // --- Overlay ---
    SettingsOverlay {
        visible-flag: root.show-settings;
        close => { root.show-settings = false; }
        send-cmd(cmd) => { root.send_command(cmd); }
        trigger-reset => {
            root.is-output-on = false;
            root.confirm_reset();
            root.show-settings = false;
        }
    }
}