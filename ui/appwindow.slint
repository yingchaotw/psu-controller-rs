import { Button, VerticalBox, LineEdit, HorizontalBox, ComboBox, TabWidget, CheckBox } from "std-widgets.slint";

// è‡ªè¨‚å…ƒä»¶ Card (ä¿æŒä¸è®Š)
component Card inherits Rectangle {
    in property <string> title: "";
    background: #2c2c2c; 
    border-radius: 8px; 
    border-width: 1px;
    border-color: #444444;
    VerticalBox {
        padding: 8px; spacing: 8px;
        Text { text: root.title; font-size: 14px; font-weight: 700; color: #ffffff; }
        @children
    }
}

export component AppWindow inherits Window {
    title: root.window-title;
    in-out property <string> window-title: "Rust PSU Controller";

    width: 800px;
    height: 600px; 
    background: #1c1c1c; 

    // --- å±¬æ€§ ---
    in-out property <[string]> available-ports: []; 
    in-out property <string> selected-port;
    in-out property <string> status-text: "Disconnected";
    in-out property <brush> status-color: #ff5555;
    in-out property <string> message-text: "---";
    in-out property <bool> show-settings: false;
    in-out property <bool> is-looping: false;
    
    // [æ–°å¢] æ˜¯å¦é–‹å•Ÿè‡ªå‹•é‡æ–°æ•´ç† (é è¨­ true)
    in-out property <bool> enable-auto-refresh: true;

    // [æ–°å¢] è¨˜éŒ„ Output æ˜¯å¦é–‹å•Ÿ
    in-out property <bool> is-output-on: false;

    in-out property <string> voltage-reading: "---";
    in-out property <string> current-reading: "---";
    in-out property <string> target-voltage: "12.00";
    in-out property <string> target-current: "1.000";

    // --- Callbacks ---
    callback toggle_connection();
    callback send_command(string);
    callback read_all();
    callback read_voltage();
    callback read_current();
    callback apply_voltage(string);
    callback apply_current(string);
    callback adjust_voltage(float);
    callback adjust_current(float);
    callback confirm_reset();
    callback toggle_loop(string, string, int);

    // [æ–°å¢] ç•¶ CheckBox åˆ‡æ›æ™‚é€šçŸ¥ Rust
    callback toggle_auto_refresh(bool);

    VerticalBox {
        padding: 15px; spacing: 10px;

        // --- 1. Header ---
        HorizontalBox {
            spacing: 10px;
            Text { text: "Port:"; vertical-alignment: center; color: white; }
            ComboBox {
                model: root.available-ports;
                current-value <=> root.selected-port;
                width: 150px;
            }
            Button {
                text: root.status-text == "Connected" ? "Disconnect" : "Connect";
                primary: root.status-text != "Connected";
                clicked => { 
                    if (root.status-text == "Connected") {
                        root.is-output-on = false;
                    }
                    root.toggle_connection(); 
                }
            }
            
            // [æ–°å¢] è‡ªå‹•æ›´æ–°é–‹é—œ
            CheckBox {
                text: "Auto-Poll";
                checked <=> root.enable-auto-refresh;
                // ç•¶ä½¿ç”¨è€…é»æ“Šæ™‚ï¼Œè§¸ç™¼ callback
                toggled => { root.toggle_auto_refresh(self.checked); }
            }

            VerticalLayout { alignment: center; Rectangle { width: 12px; height: 12px; border-radius: 6px; background: root.status-color; } }
            Button { text: "âš™ Sys"; width: 60px; clicked => { root.show-settings = true; } }
        }

        // --- 2. Tabs ---
        TabWidget {
            Tab {
                title: "Manual Control";
                HorizontalBox {
                    spacing: 15px; padding: 15px;
                    
                    // Voltage Card
                    Card {
                        title: "VOLTAGE (V)";
                        Rectangle {
                            background: #111; border-radius: 4px; height: 45px;
                            Text { text: root.voltage-reading; color: #00ff00; font-size: 26px; font-weight: 700; x: 10px; vertical-alignment: center; }
                            TouchArea { clicked => { root.read_voltage(); } }
                        }
                        HorizontalBox {
                            spacing: 5px;
                            Text { text: "Set:"; color: white; vertical-alignment: center; width: 30px;}
                            in-volt := LineEdit { text <=> root.target-voltage; }
                            Button { text: "Apply"; width: 60px; clicked => { root.apply_voltage(in-volt.text); } }
                        }
                        HorizontalBox {
                            spacing: 5px;
                            Button { text: "-0.1V"; clicked => { root.adjust_voltage(-0.1); } }
                            Button { text: "+0.1V"; clicked => { root.adjust_voltage(0.1); } }
                        }
                        Rectangle { vertical-stretch: 1; }
                    }

                    // Current Card
                    Card {
                        title: "CURRENT (A)";
                        Rectangle {
                            background: #111; border-radius: 4px; height: 45px;
                            Text { text: root.current-reading; color: #00ffff; font-size: 26px; font-weight: 700; x: 10px; vertical-alignment: center; }
                            TouchArea { clicked => { root.read_current(); } }
                        }
                        HorizontalBox {
                            spacing: 5px;
                            Text { text: "Lim:"; color: white; vertical-alignment: center; width: 30px;}
                            in-curr := LineEdit { text <=> root.target-current; }
                            Button { text: "Apply"; width: 60px; clicked => { root.apply_current(in-curr.text); } }
                        }
                        HorizontalBox {
                            spacing: 5px;
                            Button { text: "-10mA"; clicked => { root.adjust_current(-0.01); } }
                            Button { text: "+10mA"; clicked => { root.adjust_current(0.01); } }
                        }
                        Rectangle { vertical-stretch: 1; }
                    }
                }
            }

            Tab {
                title: "Auto Loop";
                VerticalBox {
                    padding: 20px; alignment: start; 
                    Card {
                        title: "LOOP CONFIGURATION";
                        VerticalBox {
                            spacing: 15px;
                            Text { text: "Toggle voltage between Level A and B."; color: #ccc; }
                            HorizontalBox {
                                Text { text: "Level A (V):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-va := LineEdit { text: "5.0"; }
                            }
                            HorizontalBox {
                                Text { text: "Level B (V):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-vb := LineEdit { text: "12.0"; }
                            }
                            HorizontalBox {
                                Text { text: "Interval (ms):"; color: white; vertical-alignment: center; width: 100px;}
                                loop-ms := LineEdit { text: "1000"; }
                            }
                            Rectangle { height: 10px; }
                            Button {
                                text: root.is-looping ? "ğŸ›‘ STOP LOOP" : "â–¶ START LOOP";
                                primary: root.is-looping; height: 50px;
                                clicked => { root.toggle_loop(loop-va.text, loop-vb.text, loop-ms.text.to-float()); }
                            }
                        }
                    }
                }
            }
        }

        // --- 3. Footer (Output Control) ---
        HorizontalBox {
            height: 50px; spacing: 20px;
            
            // [ä¿®æ”¹é‡é»] OUTPUT ON æŒ‰éˆ•
            Button {
                text: "OUTPUT ON"; 
                // åªæœ‰ç•¶ is-output-on ç‚º true æ™‚ï¼Œæ‰é¡¯ç¤ºäº®è‰² (primary)
                // å¦å‰‡é¡¯ç¤ºè·Ÿ OFF ä¸€æ¨£çš„ç°è‰²
                primary: root.is-output-on; 
                enabled: root.status-text == "Connected";
                clicked => { 
                    // æŒ‰ä¸‹æ™‚ï¼Œè®Šæ›´ç‹€æ…‹ç‚º true
                    root.is-output-on = true;
                    root.send_command("OUTP ON"); 
                }
            }
            
            // [ä¿®æ”¹é‡é»] OUTPUT OFF æŒ‰éˆ•
            Button {
                text: "OUTPUT OFF"; 
                enabled: root.status-text == "Connected";
                clicked => { 
                    // æŒ‰ä¸‹æ™‚ï¼Œè®Šæ›´ç‹€æ…‹ç‚º false
                    root.is-output-on = false;
                    root.send_command("OUTP OFF"); 
                }
            }
        }
    }

    // === Settings Overlay ===
    Rectangle {
        visible: root.show-settings;
        background: #000000aa; // èƒŒæ™¯è®Šæš—
        TouchArea {} // é˜»æ“‹é»æ“Šç©¿é€

        Rectangle {
            width: 340px; // ç¨å¾®åŠ å¯¬ä¸€é»ä»¥å®¹ç´æŒ‰éˆ•
            height: 380px; // åŠ é«˜ä»¥å®¹ç´æ–°åŠŸèƒ½
            background: #333; 
            border-radius: 12px; 
            border-color: #555; 
            border-width: 2px;
            
            VerticalBox {
                padding: 20px; 
                spacing: 15px;
                
                // æ¨™é¡Œ
                Text { 
                    text: "System Settings"; 
                    font-size: 18px; 
                    font-weight: 700; 
                    color: white; 
                    horizontal-alignment: center; 
                }
                
                Rectangle { height: 1px; background: #666; }
                
                // --- [æ–°å¢åŠŸèƒ½] èœ‚é³´å™¨æ§åˆ¶ ---
                Text { text: "Beeper Control"; color: #ccc; font-size: 14px; }
                HorizontalBox {
                    spacing: 10px;
                    Button {
                        text: "ğŸ”Š Beep ON";
                        clicked => { root.send_command("SYST:CONF:BEEP ON"); }
                    }
                    Button {
                        text: "ğŸ”‡ Mute (OFF)";
                        // é€™è£¡ä½¿ç”¨æ‚¨æä¾›çš„æŒ‡ä»¤
                        clicked => { root.send_command("SYST:CONF:BEEP OFF"); }
                    }
                }

                Rectangle { height: 5px; } // é–“éš”
                
                // --- é¢æ¿æ§åˆ¶ ---
                Text { text: "Panel Control"; color: #ccc; font-size: 14px; }
                Button { 
                    text: "Unlock Panel (Local)"; 
                    clicked => { root.send_command("SYST:LOC"); } 
                }
                
                Rectangle { height: 5px; }
                
                // --- å±éšªå€åŸŸ ---
                Text { text: "Danger Zone"; color: #ff5555; font-size: 14px; }
                Button {
                    text: "âš ï¸ Factory Reset (*RST)";
                    clicked => { 
                        root.is-output-on = false; // Reset æœƒé—œé–‰è¼¸å‡ºï¼ŒåŒæ­¥ UI ç‹€æ…‹
                        root.confirm_reset();
                        root.show-settings = false;
                    }
                }
                
                Rectangle { vertical-stretch: 1; } // æŠŠé—œé–‰æŒ‰éˆ•æ¨åˆ°åº•éƒ¨
                
                Button { 
                    text: "Close Menu"; 
                    clicked => { root.show-settings = false; } 
                }
            }
        }
    }
}